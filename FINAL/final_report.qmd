---
title: "Python Final Report"
date: last-modified
author: "Hayden Coke and Bekah Peterson"
format:
  html:
    embed-resources: true
execute: 
  echo: false
  warning: false
jupyter: python3
---

feedback from presentation:
Showing multiple time series plots as a single group of scatter plot points doesn't really make sense. A line graph would have been more appropriate.

Even though there were a lot of unanswered questions, just saying there could be unknown reasons without offering any speculation is unsatisfying. What additional info would you need to answer those questions? Where would be the first places you could look?

RUBRIC:
● General background on the topic
● Information about the source of any additional datasets
● Detailed description of any variables used in your analysis, including any that you
created/derived from other variables
● Your research question(s), and why they are important
● Appropriate figures illustrating your analysis and results
● At least one machine learning model predicting a variable of interest (this may be a simple
multi-linear regression or something more complicated if you prefer) along with any
validation tests or checks required for using that model
● Your conclusions, including supporting evidence and caveats if appropriate

# Patterns in Healthcare Spending from 1980 to 2014

## Introduction / Background

Healthcare spending is a growing concern for most Americans. The US spends more than twice as much per capita on health care as other developed countries (Pahlka, [Re]Coding America, p. 4). One in ten Americans has at least $250 in medical debt. The majority of Americans with $10,000 or more in debt do not think they will ever be able to pay it off. Families of middle or lower economic status are especially burdened by medical debt. (https://pmc.ncbi.nlm.nih.gov/articles/PMC11918610/)

This report will seek to answer the question: How has healthcare spending by state and region changed over time? 


## Methods

To answer this question, we examined a dataset of healthcare spending from 1980 to 2014, which reported individual state spending and spending by item category. Dr. Gore provided us with a census dataset which we used to match states and years to their corresponding populations. To account for inflation, we adjusted the spending amounts in the original dataset using the python package Cpi by Palewire, which uses the Consumer Price Index. After adjusting for inflation, we calculated spending per capita by dividing the spending by the state population. 

Healthcare items reported by this dataset include: Hospital Care; Physician & Clinical Services; Other Professional Services; Dental Services; Home Health Care; Prescription Drugs; Durable Medical Products; Other Non-durable Medical Products; Nursing Home Care; and Other Health, Residential, and Personal Care. By the definition on the CDC website, Personal Healthcare Spending is all healthcare spending categories combined. 

## Results



## Conclusion

In our exploration of the spending patterns we found that healthcare spending is increasing at a rate that outpaces inflation. The District of Columbia is an outlier for high spending, largely due to their very high hospital care costs. More research and analysis is needed to explain why DC hospitals are so much more expensive than in other states. DC is the most expensive "state" to live in, but that does not fully explain why hospital care in particular is more expensive. It's possible that they have care laws that are causing an increase in price, such as serving patients without insurance or requing expensive tests for patients that are not required in other states. 

Thirty four states have experienced a cost percent change of more than 200% between 1980 and 2014. New Hampshire and Vermont have experienced a percent change of more than 300%. There is some regional connection among the states with the greatest or least percent changes. Among the 5 states that experienced the greatest increase, 3 are in New England. Among the 5 states that expereienced the least increase, 3 are in the Southwest. It's possible that there is a climate connection, but a political connection is more likely. Data on healthcare policies and laws would be needed to identify any connections. 

This data set does not include any information from the last 11 years, we know that health care spending continued to increase, especially after COVID-19. Further research could explore how spending has changed since 2020, identifying where costs are increasing fastest, both by region and category. 


## References

https://palewi.re/docs/cpi/#id6

https://www.bls.gov/cpi/


## Appendix

```{python}
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

from sklearn.preprocessing import StandardScaler
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.metrics import PredictionErrorDisplay, mean_squared_error, r2_score
from scipy.stats import probplot
import statsmodels.api as sm

df_all = pd.read_csv("./datasets/healthcare_spending_states.csv")
df_personal = df_all[df_all['Item'] == 'Personal Health Care (Millions of Dollars)']
df_items = df_all[df_all['Item'] != 'Personal Health Care (Millions of Dollars)']
```

```{python}
# spending by item over time
sns.lineplot(df_items, x='Year', y='SpendAdjust', hue='Item')
plt.legend(bbox_to_anchor=(1.05, 1), loc='upper left', borderaxespad=0)
plt.xlabel("Year")
plt.ylabel("Millions of Dollars")
plt.show()
```

**Fig 1.** Spending in Millions of Dollars by Item (1980-2014). 

```{python}
# spending per capita by region (exluding DC)
df_personal_noDC = df_personal[df_personal['State'] != 'District of Columbia']
sns.lineplot(df_personal_noDC, x = 'Year', y = 'perCapSpendAdjusted', hue='Region_Name')
plt.xlabel("Year")
plt.ylabel("Spending per Capita in Millions of Dollars")
plt.show()
```

**Fig 2.** Spending per Capita in Millions of Dollars by Region, DC excluded (1980-2014). 


```{python}
df_2014 = df_personal[df_personal['Year'] == 2014]
df_1980 = df_personal[df_personal['Year'] == 1980]

spending_2014 = df_2014.groupby('State', as_index=False)['perCapSpendAdjusted'].sum()
spending_2014.rename(columns={'perCapSpendAdjusted': 'Spending Per Capita in 2014'}, inplace=True)

spending_1980 = df_1980.groupby('State', as_index=False)['perCapSpendAdjusted'].sum()
spending_1980.rename(columns={'perCapSpendAdjusted': 'Spending Per Capita in 1980'}, inplace=True)

delta = spending_1980.merge(spending_2014, on='State', how='left')
delta['Percent Change'] = (delta['Spending Per Capita in 2014'] - delta['Spending Per Capita in 1980']) / delta['Spending Per Capita in 1980'] * 100

delta.sort_values(by='Percent Change', inplace=True, ascending=False, ignore_index=True)

pd.options.display.float_format = '{:,.5f}'.format
delta['Percent Change'] = delta['Percent Change'].apply(lambda x: '{:.2f}%'.format(x))

display(delta)
```

**Table 1.** Percent growth on healthcare spending (measured in millions of dollars per capita) among states from 1980 to 2014. 

```{python}
# Can we predict the spending of a state when given its year and population?

# assumptions of linear regression:
# linearity
mat = df_personal.corr(numeric_only=True)
mat['SpendAdjust']

# SpendAdjust has a correlation coefficient of 0.96 with population 
# and 0.21 with year
x = df_personal[['Population', 'Year']]
y = df_personal['SpendAdjust']

# scale x values
x_scaled = StandardScaler().fit_transform(x)

x_train, x_test, y_train, y_test = train_test_split(x_scaled, y, test_size=0.2, random_state=17)

# fit model
model = LinearRegression().fit(x_train, y_train)
y_pred = model.predict(x_test)

print("Mean Squared Error:", mean_squared_error(y_test, y_pred))
print("R-squared:", r2_score(y_test, y_pred))
print("score:", model.score(x, y))
print("coef:", model.coef_)

# Residual Plot
residuals = y_test - y_pred
plt.scatter(y_pred, residuals, alpha=0.5)
plt.xlabel('Predicted Values')
plt.ylabel('Residuals')
plt.title('Residual Plot')
plt.axhline(y=0, color='red', linestyle='--')
plt.show()

# Predicted vs Actual Plot
plt.scatter(y_test, y_pred, alpha=0.5)
plt.xlabel('Actual Values')
plt.ylabel('Predicted Values')
plt.title('Predicted vs Actual Values')
plt.plot([y_test.min(), y_test.max()], [y_test.min(), y_test.max()], 'r--', lw=4)
plt.show()

# Add a constant to the model
x_train_sm = sm.add_constant(x_train)
model_sm = sm.OLS(y_train, x_train_sm).fit()
print(model_sm.summary())

# Q-Q Plot for residuals
sm.qqplot(model_sm.resid, line='s')
plt.title('Q-Q Plot of Residuals')
plt.show()

```